<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Marker Clustering!!!</title>
    <script src="main.js"></script>
    <script src="https://www.chaijs.com/chai.js" type="text/javascript"></script>
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 600px;
        width: 800px;
        margin: 20px;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      .box {
        margin: 20px;
      }
    </style>
  </head>
  <body>
    <div class="box" >
      <button onclick="javascript:go()">GO</button>
    </div>
    <div id="map"></div>
    <script>
      const mapElement = document.getElementById("map");
      console.log("mapElement:", mapElement);
      chai.expect(mapElement).property("clientWidth").above(0);
      chai.expect(mapElement).property("clientHeight").above(0);
      const width = mapElement.clientWidth;
      const height = mapElement.clientHeight;

      //data
    console.log("data raw string:", data);
    const dataJson = JSON.parse(data);
    console.log("data json:", dataJson);

      var map;
      // Create an array of alphabetical characters used to label the markers.
      var labels = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';

      function initMap() {

        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 0,
          center: {lat: 0, lng: 0}
        });



      }
      var locations = dataJson.map(d => ({
        lat: d.centroid.coordinates[1],
        lng: d.centroid.coordinates[0],
      }));
      console.log("location:", locations);

      var locations2 = JSON.parse(data2).map(d => ({
        coordinate: {
          lat: d.centroid.coordinates[1],
          lng: d.centroid.coordinates[0],
        },
        label: d.count,
      }));
      console.log("location2:", locations2);

      function go(){
//        // Add some markers to the map.
//        // Note: The code uses the JavaScript Array.prototype.map() method to
//        // create an array of markers based on a given "locations" array.
//        // The map() method here has nothing to do with the Google Maps API.
//        var markers = locations.map(function(location, i) {
//          return new google.maps.Marker({
//            position: location,
//            label: labels[i % labels.length]
//          });
//        });
//
//        // Add a marker clusterer to manage the markers.
//        var markerCluster = new MarkerClusterer(map, markers,
//            {
//              imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m',
//              minimumClusterSize: 9999990,
//            });

        //adjust the map to fit the markers' bounds
        const bounds = new google.maps.LatLngBounds();
        console.log("bounds:", bounds);
//        for(let marker of markers){
//          console.assert(marker.getPosition(), 'get position');
//          bounds.extend(marker.getPosition());
//        }
        for(let location of locations){
          chai.expect(location).property("lat").a("number"); 
          chai.expect(location).property("lng").a("number"); 
          bounds.extend(location);
        }
        console.log("bounds:", bounds);
        //move the map
        //map.fitBounds(bounds);
        chai.assert(bounds);
        console.log("center", bounds.getCenter());
        console.log("bounds", bounds.toJSON());
        map.panTo(bounds.getCenter());
        //cal zoom
        let zoom;
        {
          var GLOBE_WIDTH = 256; // a constant in Google's map projection
          var west = bounds.getSouthWest().lng();
          var east = bounds.getNorthEast().lng();
          var angle = east - west;
          if (angle < 0) {
            angle += 360;
          }
          zoom = Math.round(Math.log(width * 360 / angle / GLOBE_WIDTH) / Math.LN2);
          console.log("zoom1:", zoom);
        }
        let zoom2;
        {
          var GLOBE_WIDTH = 256; // a constant in Google's map projection
          var south = bounds.getSouthWest().lat();
          var north = bounds.getNorthEast().lat();
          var angle = north - south;
          console.log("angle:", angle);
//          if (angle < 0) {
//            angle += 360;
//          }
          angle = Math.abs(angle);
          console.log("angle:", angle);
          zoom2 = Math.round(Math.log(height * 360 / angle / GLOBE_WIDTH) / Math.LN2);
          console.log("zoom2:", zoom2);
        }
        console.log("height:", height, "width:", width);
        const zoomFinal = Math.min(zoom, zoom2);
        console.log("zoom final:", zoomFinal);
        map.setZoom(zoomFinal - 1 /* to give some padding*/);

        //markers
        var markers = locations2.map(function(location, i) {
          chai.expect(location).property("label").a("number");
          return new google.maps.Marker({
            position: location.coordinate,
            label: location.label+"",
          });
        });

        // Add a marker clusterer to manage the markers.
        var markerCluster = new MarkerClusterer(map, markers,
            {
              imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m',
              minimumClusterSize: 9999990,
            });
      }
      setTimeout(() => {
        go();
      }, 3000);
    </script>
    <!-- Replace following script src -->
    <!--
    <script src="/maps/documentation/javascript/examples/markerclusterer/markerclustererplus@4.0.1.min.js">
      -->
    <script src="./markerclustererplus.min.js">
    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA1QIeijbBWmCv3wjjo2TbVr4MJbCS4vmA&callback=initMap">
    </script>
  </body>
</html>
